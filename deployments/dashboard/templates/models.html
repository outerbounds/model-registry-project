{% extends "base.html" %}

{% block title %}Model Registry{% endblock %}

{% block content %}
<h1>Model Registry</h1>

{% if error_message %}
<div class="alert alert-warning">
    {{ error_message }}
</div>
{% endif %}

<!-- Champion Summary -->
{% if champion %}
<div class="card" style="border-left: 4px solid var(--green-500);">
    <div class="card-header">
        <div class="card-title">Production Model (Champion)</div>
        <span class="badge badge-success">{{ champion.alias or 'latest' }}</span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        <!-- Model Info -->
        <div>
            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--gray-600);">Model</h4>
            <div style="font-size: 0.875rem;">
                <div><strong>Version:</strong> <code>{{ champion.version|format_version }}</code></div>
                <div><strong>Algorithm:</strong> {{ champion.algorithm or 'isolation_forest' }}</div>
                <div><strong>Estimators:</strong> {{ champion.n_estimators or '-' }}</div>
                <div><strong>Contamination:</strong> {{ "%.0f"|format(champion.contamination * 100) if champion.contamination else '-' }}%</div>
                <div><strong>Anomaly Rate:</strong> {{ "%.1f"|format(champion.anomaly_rate * 100) if champion.anomaly_rate else '-' }}%</div>
            </div>
        </div>

        <!-- Data Lineage -->
        <div>
            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--gray-600);">Training Data</h4>
            <div style="font-size: 0.875rem;">
                <div><strong>Dataset:</strong> <code>{{ champion.data_source or '-' }}</code></div>
                {% if champion.data_snapshot_count %}
                <div><strong>Snapshots:</strong> {{ champion.data_snapshot_count }}</div>
                {% endif %}
                {% if champion.data_snapshot_start and champion.data_snapshot_end %}
                <div><strong>Range:</strong> {{ champion.data_snapshot_start|format_timestamp }} to {{ champion.data_snapshot_end|format_timestamp }}</div>
                {% endif %}
                <div><strong>Samples:</strong> {{ champion.training_samples or '-' }}</div>
            </div>
        </div>

        <!-- Outcome Metrics (if available) -->
        <div>
            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--gray-600);">Outcome Validation</h4>
            {% if champion.outcome_metrics %}
            <div style="font-size: 0.875rem;">
                <div><strong>Crash Recall:</strong>
                    {% if champion.outcome_metrics.crash_recall >= 0.5 %}
                    <span style="color: var(--green-600);">{{ "%.0f"|format(champion.outcome_metrics.crash_recall * 100) }}%</span>
                    {% else %}
                    <span style="color: var(--orange-600);">{{ "%.0f"|format(champion.outcome_metrics.crash_recall * 100) }}%</span>
                    {% endif %}
                </div>
                <div><strong>Precision:</strong>
                    {% if champion.outcome_metrics.anomaly_precision >= 0.3 %}
                    <span style="color: var(--green-600);">{{ "%.0f"|format(champion.outcome_metrics.anomaly_precision * 100) }}%</span>
                    {% else %}
                    <span style="color: var(--orange-600);">{{ "%.0f"|format(champion.outcome_metrics.anomaly_precision * 100) }}%</span>
                    {% endif %}
                </div>
                <div><strong>False Alarm Rate:</strong> {{ "%.0f"|format(champion.outcome_metrics.false_alarm_rate * 100) }}%</div>
                <div class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">
                    Validated: {{ champion.outcome_metrics.validated_at|format_timestamp }}
                </div>
            </div>
            {% else %}
            <div class="text-muted" style="font-size: 0.875rem;">
                No outcome validation yet.<br>
                Run <code>ValidateOutcomesFlow</code> to measure real-world performance.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% elif champion_count == 0 %}
<div class="card" style="border-left: 4px solid var(--orange-500);">
    <div class="card-header">
        <div class="card-title">No Champion Model</div>
        <span class="badge badge-warning">Action Required</span>
    </div>
    <p class="text-muted" style="margin: 0;">
        No model is currently designated as champion. Promote a model version below to set it as the production model.
    </p>
</div>
{% endif %}

{% if champion_count > 1 %}
<div class="alert alert-warning">
    Warning: {{ champion_count }} models have the "champion" alias. There should only be one champion per branch.
</div>
{% endif %}

<!-- Model Comparison Tool -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Compare Models</div>
    </div>
    <div class="flex gap-2 items-center" style="flex-wrap: wrap;">
        <div>
            <label for="compare-v1">Version 1</label>
            <select id="compare-v1" style="min-width: 180px;">
                {% for v in versions %}
                <option value="v{{ v.version }}">{{ v.version|format_version }}{% if v.alias %} ({{ v.alias }}){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div style="padding-top: 1.5rem;">vs</div>
        <div>
            <label for="compare-v2">Version 2</label>
            <select id="compare-v2" style="min-width: 180px;">
                {% for v in versions %}
                <option value="v{{ v.version }}" {% if loop.index == 2 %}selected{% endif %}>{{ v.version|format_version }}{% if v.alias %} ({{ v.alias }}){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div style="padding-top: 1.5rem;">
            <button class="btn btn-primary" onclick="compareModels()">Compare</button>
        </div>
    </div>
    <div id="comparison-results" style="margin-top: 1rem; display: none;">
        <!-- Results will be inserted here -->
    </div>
</div>

<!-- Model Versions Table -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Model Versions</div>
        <span class="badge badge-info">{{ versions|length }} versions</span>
    </div>

    {% if versions %}
    <div class="table-wrapper">
    <table style="table-layout: auto;">
        <thead>
            <tr>
                <th style="width: 140px;">Version</th>
                <th style="width: 90px;">Alias</th>
                <th style="width: 80px;">Estimators</th>
                <th style="width: 90px;">Contamination</th>
                <th style="width: 100px;">Anomaly Rate</th>
                <th style="width: 100px;">Training Samples</th>
                <th style="width: 150px;">Data Source</th>
                <th style="width: 80px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for v in versions %}
            <tr>
                <td>
                    <span class="font-mono" title="{{ v.version }}">{{ v.version|format_version }}</span>
                </td>
                <td>
                    {% if v.alias == 'champion' %}
                        <span class="badge badge-success">{{ v.alias }}</span>
                    {% elif v.alias == 'candidate' %}
                        <span class="badge badge-warning">{{ v.alias }}</span>
                    {% elif v.alias == 'staging' %}
                        <span class="badge badge-info">{{ v.alias }}</span>
                    {% elif v.alias %}
                        <span class="badge badge-gray">{{ v.alias }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if v.n_estimators %}
                        {{ v.n_estimators }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if v.contamination %}
                        {{ "%.0f"|format(v.contamination * 100) }}%
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if v.anomaly_rate is not none %}
                        {{ "%.1f"|format(v.anomaly_rate * 100) }}%
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ v.training_samples or '-' }}</td>
                <td>
                    {% if v.data_source %}
                        {% if ':v' in v.data_source %}
                            {# Show asset:version format nicely - extract just the version part for display #}
                            {% set parts = v.data_source.split(':v') %}
                            <span class="font-mono" style="font-size: 0.8rem;" title="{{ v.data_source }}">
                                {{ parts[0][:12] }}:v{{ parts[1] }}
                            </span>
                        {% elif ':' in v.data_source and 'latest' in v.data_source %}
                            {# Unresolved alias like "training_dataset:latest" - show warning #}
                            {% set parts = v.data_source.split(':') %}
                            <span class="font-mono" style="font-size: 0.8rem; color: var(--orange-600);" title="{{ v.data_source }} (unresolved alias)">
                                {{ parts[0][:8] }}:{{ parts[1] }}
                            </span>
                        {% else %}
                            {# Simple value like "coingecko_live" #}
                            <span class="font-mono" style="font-size: 0.8rem;" title="{{ v.data_source }}">
                                {{ v.data_source }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if v.alias != 'champion' %}
                    <button class="btn btn-sm" onclick="promoteModel('{{ v.version }}')" title="Promote to champion">
                        Promote
                    </button>
                    {% else %}
                    <span class="text-muted">Current</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">&#x1F916;</div>
        <p>No model versions registered yet</p>
        <p class="text-muted mt-1">Run TrainFlow to create models</p>
    </div>
    {% endif %}
</div>

<!-- Model Lifecycle -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Model Lifecycle</div>
    </div>
    <div style="display: flex; align-items: center; justify-content: space-around; padding: 1rem; background: var(--sand-100); border-radius: 0.5rem;">
        <div class="text-center">
            <span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">Train</span>
            <div class="text-muted mt-1" style="font-size: 0.875rem;">New version created</div>
        </div>
        <div style="color: var(--gray-200); font-size: 1.5rem;">&#x2192;</div>
        <div class="text-center">
            <span class="badge badge-warning" style="font-size: 1rem; padding: 0.5rem 1rem;">Evaluate</span>
            <div class="text-muted mt-1" style="font-size: 0.875rem;">Quality gates</div>
        </div>
        <div style="color: var(--gray-200); font-size: 1.5rem;">&#x2192;</div>
        <div class="text-center">
            <span class="badge badge-success" style="font-size: 1rem; padding: 0.5rem 1rem;">Promote</span>
            <div class="text-muted mt-1" style="font-size: 0.875rem;">Assign alias</div>
        </div>
    </div>
    <p class="text-muted mt-2" style="font-size: 0.875rem; text-align: center;">
        Aliases like "champion" or "production" are assigned via promotion. Any version can be loaded by version ID or alias.
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
async function compareModels() {
    const v1 = document.getElementById('compare-v1').value;
    const v2 = document.getElementById('compare-v2').value;
    const branch = new URLSearchParams(window.location.search).get('branch') || '{{ branch }}';

    if (v1 === v2) {
        alert('Please select two different versions to compare');
        return;
    }

    try {
        const response = await fetch(`/api/models/compare?v1=${v1}&v2=${v2}&branch=${branch}`);
        const data = await response.json();

        if (response.ok) {
            const resultsDiv = document.getElementById('comparison-results');
            resultsDiv.style.display = 'block';
            // Format timestamp for display
            const formatTime = (ts) => ts ? ts.replace('T', ' ').substring(0, 19) : '-';

            resultsDiv.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>${data.v1.version}${data.v1.alias ? ' (' + data.v1.alias + ')' : ''}</th>
                            <th>${data.v2.version}${data.v2.alias ? ' (' + data.v2.alias + ')' : ''}</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Hyperparameters</strong></td>
                            <td colspan="3" style="background: var(--sand-100);"></td>
                        </tr>
                        <tr>
                            <td>n_estimators</td>
                            <td>${data.v1.n_estimators || '-'}</td>
                            <td>${data.v2.n_estimators || '-'}</td>
                            <td>${data.v1.n_estimators && data.v2.n_estimators ? (data.v1.n_estimators - data.v2.n_estimators > 0 ? '+' : '') + (data.v1.n_estimators - data.v2.n_estimators) : '-'}</td>
                        </tr>
                        <tr>
                            <td>contamination</td>
                            <td>${data.v1.contamination ? (data.v1.contamination * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v2.contamination ? (data.v2.contamination * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v1.contamination && data.v2.contamination ? ((data.v1.contamination - data.v2.contamination) * 100).toFixed(0) + '%' : '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Quality Metrics</strong></td>
                            <td colspan="3" style="background: var(--sand-100);"></td>
                        </tr>
                        <tr>
                            <td>Score Gap (separation)</td>
                            <td>${data.v1.score_gap ? data.v1.score_gap.toFixed(3) : '-'}</td>
                            <td>${data.v2.score_gap ? data.v2.score_gap.toFixed(3) : '-'}</td>
                            <td>${data.v1.score_gap && data.v2.score_gap ? (data.v1.score_gap - data.v2.score_gap > 0 ? '+' : '') + (data.v1.score_gap - data.v2.score_gap).toFixed(3) : '-'}</td>
                        </tr>
                        <tr>
                            <td>Anomaly Rate</td>
                            <td>${data.v1.anomaly_rate ? (data.v1.anomaly_rate * 100).toFixed(1) + '%' : '-'}</td>
                            <td>${data.v2.anomaly_rate ? (data.v2.anomaly_rate * 100).toFixed(1) + '%' : '-'}</td>
                            <td><span class="text-muted">(= contamination)</span></td>
                        </tr>
                        <tr>
                            <td>Training Samples</td>
                            <td>${data.v1.training_samples || '-'}</td>
                            <td>${data.v2.training_samples || '-'}</td>
                            <td>${data.v1.training_samples && data.v2.training_samples ? data.v1.training_samples - data.v2.training_samples : '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Lineage</strong></td>
                            <td colspan="3" style="background: var(--sand-100);"></td>
                        </tr>
                        <tr>
                            <td>Training Run</td>
                            <td>${data.v1.training_run_id || '-'}</td>
                            <td>${data.v2.training_run_id || '-'}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Trained At</td>
                            <td>${formatTime(data.v1.created_at)}</td>
                            <td>${formatTime(data.v2.created_at)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Data Snapshot</td>
                            <td>${formatTime(data.v1.data_timestamp)}</td>
                            <td>${formatTime(data.v2.data_timestamp)}</td>
                            <td>${data.v1.data_timestamp === data.v2.data_timestamp ? 'Same data' : 'Different'}</td>
                        </tr>
                        ${data.v1.data_snapshot_count || data.v2.data_snapshot_count ? `
                        <tr>
                            <td>Snapshot Count</td>
                            <td>${data.v1.data_snapshot_count || '-'}</td>
                            <td>${data.v2.data_snapshot_count || '-'}</td>
                            <td>-</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td><strong>Outcome Validation</strong></td>
                            <td colspan="3" style="background: var(--sand-100);"></td>
                        </tr>
                        <tr>
                            <td>Crash Recall</td>
                            <td>${data.v1.outcome_metrics ? (data.v1.outcome_metrics.crash_recall * 100).toFixed(0) + '%' : '<span class="text-muted">Not validated</span>'}</td>
                            <td>${data.v2.outcome_metrics ? (data.v2.outcome_metrics.crash_recall * 100).toFixed(0) + '%' : '<span class="text-muted">Not validated</span>'}</td>
                            <td>${data.v1.outcome_metrics && data.v2.outcome_metrics ? ((data.v1.outcome_metrics.crash_recall - data.v2.outcome_metrics.crash_recall) * 100).toFixed(0) + '%' : '-'}</td>
                        </tr>
                        <tr>
                            <td>Anomaly Precision</td>
                            <td>${data.v1.outcome_metrics ? (data.v1.outcome_metrics.anomaly_precision * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v2.outcome_metrics ? (data.v2.outcome_metrics.anomaly_precision * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v1.outcome_metrics && data.v2.outcome_metrics ? ((data.v1.outcome_metrics.anomaly_precision - data.v2.outcome_metrics.anomaly_precision) * 100).toFixed(0) + '%' : '-'}</td>
                        </tr>
                        <tr>
                            <td>False Alarm Rate</td>
                            <td>${data.v1.outcome_metrics ? (data.v1.outcome_metrics.false_alarm_rate * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v2.outcome_metrics ? (data.v2.outcome_metrics.false_alarm_rate * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${data.v1.outcome_metrics && data.v2.outcome_metrics ? ((data.v1.outcome_metrics.false_alarm_rate - data.v2.outcome_metrics.false_alarm_rate) * 100).toFixed(0) + '%' : '-'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        } else {
            alert('Comparison failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function promoteModel(version) {
    const branch = new URLSearchParams(window.location.search).get('branch') || '{{ branch }}';

    if (!confirm(`Promote version ${version} to champion?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/models/promote?version=${encodeURIComponent(version)}&alias=champion&branch=${branch}`, {
            method: 'POST',
        });
        const data = await response.json();

        if (data.success) {
            alert('Model promoted to champion! Refreshing...');
            window.location.reload();
        } else if (data.message) {
            // Show the message with command to run
            const msg = data.message + (data.command ? '\n\nCommand copied to clipboard.' : '');
            alert(msg);

            // Copy command to clipboard if available
            if (data.command && navigator.clipboard) {
                navigator.clipboard.writeText(data.command).catch(() => {});
            }
        } else {
            alert('Promotion failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}

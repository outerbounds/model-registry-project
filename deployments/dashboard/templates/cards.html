{% extends "base.html" %}

{% block title %}Flow Cards{% endblock %}

{% block content %}
<h1>Metaflow Cards</h1>

<p class="text-muted mb-2">
    View rich visualizations generated by Metaflow flows. Each step with a <code>@card</code> decorator produces a card.
</p>

<!-- Side-by-side comparison -->
<div class="card mb-2">
    <div class="card-header">
        <span class="card-title">Compare Cards</span>
    </div>
    {% if cards %}
    <div class="flex gap-2 items-center" style="flex-wrap: wrap;">
        <div>
            <label for="card-left">Left Card</label>
            <select id="card-left" style="min-width: 200px;">
                {% for card in cards %}
                <option value="{{ card.url }}">{{ card.flow_name }} ({{ card.run_id[:20] }}{% if card.run_id|length > 20 %}...{% endif %})</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="card-right">Right Card</label>
            <select id="card-right" style="min-width: 200px;">
                {% for card in cards %}
                <option value="{{ card.url }}" {% if loop.index == 2 %}selected{% endif %}>{{ card.flow_name }} ({{ card.run_id[:20] }}{% if card.run_id|length > 20 %}...{% endif %})</option>
                {% endfor %}
            </select>
        </div>
        <div style="padding-top: 1.5rem;">
            <button class="btn btn-primary" onclick="showSideBySide()">Compare Side-by-Side</button>
        </div>
    </div>
    <p class="text-muted mt-2" style="font-size: 0.8rem;">
        Compare training cards across runs to see how score distributions, anomaly rates, and detected coins change over time.
    </p>
    {% else %}
    <div class="text-muted">
        No cards available for this branch. Run flows with <code>@card</code> decorator first.
    </div>
    {% endif %}
</div>

{% if cards %}
<div class="grid grid-2">
    {% for card in cards %}
    <div class="card">
        <div class="card-header">
            <span class="card-title">{{ card.flow_name }}</span>
            <span class="badge badge-info">{{ card.alias }}</span>
        </div>

        <div class="metric">
            <span class="metric-label">Run ID</span>
            <span class="metric-value font-mono">{{ card.run_id }}</span>
        </div>

        {% if card.created_at %}
        <div class="metric">
            <span class="metric-label">Created</span>
            <span class="metric-value">{{ card.created_at|format_timestamp }}</span>
        </div>
        {% endif %}

        <div class="metric">
            <span class="metric-label">Steps with Cards</span>
            <span class="metric-value">
                {% if card.step_cards %}
                    {% for sc in card.step_cards %}
                        <span class="badge badge-gray" style="font-size: 0.7rem;">{{ sc.step_name }}</span>
                    {% endfor %}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </span>
        </div>

        <div class="mt-2">
            <a href="{{ card.url }}" target="_blank" class="btn btn-primary">
                View Card
            </a>
            <button class="btn btn-secondary" onclick="showCardPreview('{{ card.url }}', '{{ card.flow_name }}')">
                Preview
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal for single card preview -->
<div id="card-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; margin: 2rem auto; max-width: 90%; max-height: 90vh; background: white; border-radius: 0.75rem; overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--sand-300);">
            <span id="modal-title" style="font-weight: 600;"></span>
            <button onclick="closeCardPreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <iframe id="card-iframe" style="width: 100%; height: calc(90vh - 60px); border: none;"></iframe>
    </div>
</div>

<!-- Modal for side-by-side comparison -->
<div id="compare-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; margin: 1rem; height: calc(100vh - 2rem); background: white; border-radius: 0.75rem; overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--sand-300);">
            <span style="font-weight: 600;">Side-by-Side Comparison</span>
            <button onclick="closeCompareModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div style="display: flex; height: calc(100% - 60px);">
            <iframe id="compare-left" style="width: 50%; height: 100%; border: none; border-right: 1px solid var(--sand-300);"></iframe>
            <iframe id="compare-right" style="width: 50%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

<script>
function showCardPreview(url, title) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('card-iframe').src = url;
    document.getElementById('card-modal').style.display = 'block';
}

function closeCardPreview() {
    document.getElementById('card-modal').style.display = 'none';
    document.getElementById('card-iframe').src = '';
}

function showSideBySide() {
    const leftUrl = document.getElementById('card-left').value;
    const rightUrl = document.getElementById('card-right').value;

    document.getElementById('compare-left').src = leftUrl;
    document.getElementById('compare-right').src = rightUrl;
    document.getElementById('compare-modal').style.display = 'block';
}

function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
    document.getElementById('compare-left').src = '';
    document.getElementById('compare-right').src = '';
}

// Close modals on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCardPreview();
        closeCompareModal();
    }
});

// Close modals when clicking backdrop
document.getElementById('card-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCardPreview();
});
document.getElementById('compare-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCompareModal();
});
</script>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“Š</div>
        <p>No flow cards available yet.</p>
        <p class="text-muted mt-1">Run a flow with <code>@card</code> decorator to generate cards.</p>
    </div>
</div>
{% endif %}

<div class="card mt-2">
    <div class="card-header">
        <span class="card-title">Available Endpoints</span>
    </div>

    <table>
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>/cards/train/latest</code></td>
                <td>Latest TrainDetectorFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/evaluate/latest</code></td>
                <td>Latest EvaluateDetectorFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/ingest/latest</code></td>
                <td>Latest IngestMarketDataFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/build_dataset/latest</code></td>
                <td>Latest BuildDatasetFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/{flow}/{run_id}</code></td>
                <td>Card for a specific run</td>
            </tr>
        </tbody>
    </table>

    <p class="text-muted mt-2">
        Embed cards in external dashboards using iframes:
        <code>&lt;iframe src="/cards/train/latest"&gt;&lt;/iframe&gt;</code>
    </p>
</div>
{% endblock %}

{% extends "base.html" %}

{% block title %}Flow Cards{% endblock %}

{% block content %}
<h1>Metaflow Cards</h1>

<p class="text-muted mb-2">
    View rich visualizations generated by Metaflow flows. Each step with a <code>@card</code> decorator produces a card.
</p>

<!-- Side-by-side comparison -->
<div class="card mb-2">
    <div class="card-header">
        <span class="card-title">Compare Cards</span>
    </div>
    {% if cards %}
    <!-- Comparison mode toggle -->
    <div class="mb-2">
        <label style="margin-right: 1rem;">
            <input type="radio" name="compare-mode" value="cross-flow" checked onchange="updateCompareMode()">
            Cross-flow <span class="text-muted" style="font-size: 0.8rem;">(compare different flows)</span>
        </label>
        <label>
            <input type="radio" name="compare-mode" value="intra-flow" onchange="updateCompareMode()">
            Intra-flow <span class="text-muted" style="font-size: 0.8rem;">(compare runs of same flow)</span>
        </label>
    </div>

    <!-- Cross-flow comparison (original) -->
    <div id="cross-flow-controls" class="flex gap-2 items-center" style="flex-wrap: wrap;">
        <div>
            <label for="card-left">Left Card</label>
            <select id="card-left" style="min-width: 200px;">
                {% for card in cards %}
                <option value="{{ card.url }}">{{ card.flow_name }} ({{ card.run_id[:20] }}{% if card.run_id|length > 20 %}...{% endif %})</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="card-right">Right Card</label>
            <select id="card-right" style="min-width: 200px;">
                {% for card in cards %}
                <option value="{{ card.url }}" {% if loop.index == 2 %}selected{% endif %}>{{ card.flow_name }} ({{ card.run_id[:20] }}{% if card.run_id|length > 20 %}...{% endif %})</option>
                {% endfor %}
            </select>
        </div>
        <div style="padding-top: 1.5rem;">
            <button class="btn btn-primary" onclick="showSideBySide()">Compare Side-by-Side</button>
        </div>
    </div>

    <!-- Intra-flow comparison (new) -->
    <div id="intra-flow-controls" class="flex gap-2 items-center" style="flex-wrap: wrap; display: none;">
        <div>
            <label for="intra-flow-select">Flow</label>
            <select id="intra-flow-select" style="min-width: 180px;" onchange="updateIntraFlowVersions()">
                {% for alias, flow_data in flow_runs.items() %}
                <option value="{{ alias }}" data-flow-name="{{ flow_data.flow_name }}">{{ flow_data.flow_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="intra-left">Left (newer)</label>
            <select id="intra-left" style="min-width: 220px;"></select>
        </div>
        <div>
            <label for="intra-right">Right (older)</label>
            <select id="intra-right" style="min-width: 220px;"></select>
        </div>
        <div style="padding-top: 1.5rem;">
            <button class="btn btn-primary" onclick="showIntraFlowComparison()">Compare Versions</button>
        </div>
    </div>

    <p class="text-muted mt-2" style="font-size: 0.8rem;">
        <strong>Cross-flow:</strong> Compare cards from different flows (e.g., Train vs Evaluate).<br>
        <strong>Intra-flow:</strong> Compare runs of the same flow over time (e.g., latest vs latest-1 training runs).
    </p>
    {% else %}
    <div class="text-muted">
        No cards available for this branch. Run flows with <code>@card</code> decorator first.
    </div>
    {% endif %}
</div>

{% if cards %}
<div class="grid grid-2">
    {% for card in cards %}
    <div class="card">
        <div class="card-header">
            <span class="card-title">{{ card.flow_name }}</span>
            <span class="badge badge-info">{{ card.alias }}</span>
        </div>

        <div class="metric">
            <span class="metric-label">Run ID</span>
            <span class="metric-value font-mono">{{ card.run_id }}</span>
        </div>

        {% if card.created_at %}
        <div class="metric">
            <span class="metric-label">Created</span>
            <span class="metric-value">{{ card.created_at|format_timestamp }}</span>
        </div>
        {% endif %}

        <div class="metric">
            <span class="metric-label">Steps with Cards</span>
            <span class="metric-value">
                {% if card.step_cards %}
                    {% for sc in card.step_cards %}
                        <span class="badge badge-gray" style="font-size: 0.7rem;">{{ sc.step_name }}</span>
                    {% endfor %}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </span>
        </div>

        <div class="mt-2">
            <a href="{{ card.url }}" target="_blank" class="btn btn-primary">
                View Card
            </a>
            <button class="btn btn-secondary" onclick="showCardPreview('{{ card.url }}', '{{ card.flow_name }}')">
                Preview
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal for single card preview -->
<div id="card-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; margin: 2rem auto; max-width: 90%; max-height: 90vh; background: white; border-radius: 0.75rem; overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--sand-300);">
            <span id="modal-title" style="font-weight: 600;"></span>
            <button onclick="closeCardPreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <iframe id="card-iframe" style="width: 100%; height: calc(90vh - 60px); border: none;"></iframe>
    </div>
</div>

<!-- Modal for side-by-side comparison -->
<div id="compare-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; margin: 1rem; height: calc(100vh - 2rem); background: white; border-radius: 0.75rem; overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--sand-300); background: var(--sand-100);">
            <span style="font-weight: 600;">Side-by-Side Comparison</span>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 14px; cursor: pointer; color: var(--gray-300);">
                    <input type="checkbox" id="lock-y-axes" style="cursor: pointer;">
                    Lock Y Axes
                </label>
                <button onclick="closeCompareModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-300);">&times;</button>
            </div>
        </div>
        <div style="display: flex; height: calc(100% - 60px);">
            <iframe id="compare-left" style="width: 50%; height: 100%; border: none; border-right: 1px solid var(--sand-300);"></iframe>
            <iframe id="compare-right" style="width: 50%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

<script>
// Flow runs data from server (for intra-flow comparison)
const flowRunsData = {{ flow_runs | tojson | safe }};

function showCardPreview(url, title) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('card-iframe').src = url;
    document.getElementById('card-modal').style.display = 'block';
}

function closeCardPreview() {
    document.getElementById('card-modal').style.display = 'none';
    document.getElementById('card-iframe').src = '';
}

function showSideBySide() {
    const leftUrl = document.getElementById('card-left').value;
    const rightUrl = document.getElementById('card-right').value;

    document.getElementById('compare-left').src = leftUrl;
    document.getElementById('compare-right').src = rightUrl;
    document.getElementById('compare-modal').style.display = 'block';
}

function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
    document.getElementById('compare-left').src = '';
    document.getElementById('compare-right').src = '';
}

// Toggle between cross-flow and intra-flow comparison modes
function updateCompareMode() {
    const mode = document.querySelector('input[name="compare-mode"]:checked').value;
    document.getElementById('cross-flow-controls').style.display = mode === 'cross-flow' ? 'flex' : 'none';
    document.getElementById('intra-flow-controls').style.display = mode === 'intra-flow' ? 'flex' : 'none';

    if (mode === 'intra-flow') {
        updateIntraFlowVersions();
    }
}

// Update version dropdowns when flow selection changes
function updateIntraFlowVersions() {
    const flowSelect = document.getElementById('intra-flow-select');
    const alias = flowSelect.value;
    const flowData = flowRunsData[alias];

    if (!flowData || !flowData.runs || flowData.runs.length === 0) {
        document.getElementById('intra-left').innerHTML = '<option value="">No runs available</option>';
        document.getElementById('intra-right').innerHTML = '<option value="">No runs available</option>';
        return;
    }

    const runs = flowData.runs;

    // Format run ID for display (truncate if needed)
    function formatRunId(runId) {
        if (runId.length > 25) {
            return runId.substring(0, 25) + '...';
        }
        return runId;
    }

    // Format timestamp for display
    function formatTimestamp(isoStr) {
        if (!isoStr) return '';
        const d = new Date(isoStr);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Build options with run info
    let leftOptions = '';
    let rightOptions = '';

    runs.forEach((run, idx) => {
        const label = `${formatRunId(run.run_id)} (${formatTimestamp(run.created_at)})`;
        leftOptions += `<option value="${run.url}" ${idx === 0 ? 'selected' : ''}>${label}</option>`;
        rightOptions += `<option value="${run.url}" ${idx === 1 ? 'selected' : ''}>${label}</option>`;
    });

    document.getElementById('intra-left').innerHTML = leftOptions;
    document.getElementById('intra-right').innerHTML = rightOptions;
}

// Show intra-flow comparison
function showIntraFlowComparison() {
    const leftUrl = document.getElementById('intra-left').value;
    const rightUrl = document.getElementById('intra-right').value;

    if (!leftUrl || !rightUrl) {
        alert('Please select two runs to compare');
        return;
    }

    document.getElementById('compare-left').src = leftUrl;
    document.getElementById('compare-right').src = rightUrl;
    document.getElementById('compare-modal').style.display = 'block';
}

// Close modals on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCardPreview();
        closeCompareModal();
    }
});

// Close modals when clicking backdrop
document.getElementById('card-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCardPreview();
});
document.getElementById('compare-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCompareModal();
});

// Initialize intra-flow versions on page load
document.addEventListener('DOMContentLoaded', function() {
    if (Object.keys(flowRunsData).length > 0) {
        updateIntraFlowVersions();
    }
});
</script>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“Š</div>
        <p>No flow cards available yet.</p>
        <p class="text-muted mt-1">Run a flow with <code>@card</code> decorator to generate cards.</p>
    </div>
</div>
{% endif %}

<div class="card mt-2">
    <div class="card-header">
        <span class="card-title">Available Endpoints</span>
    </div>

    <table>
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>/cards/train/latest</code></td>
                <td>Latest TrainDetectorFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/evaluate/latest</code></td>
                <td>Latest EvaluateDetectorFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/ingest/latest</code></td>
                <td>Latest IngestMarketDataFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/build_dataset/latest</code></td>
                <td>Latest BuildDatasetFlow card</td>
            </tr>
            <tr>
                <td><code>/cards/{flow}/{run_id}</code></td>
                <td>Card for a specific run</td>
            </tr>
        </tbody>
    </table>

    <p class="text-muted mt-2">
        Embed cards in external dashboards using iframes:
        <code>&lt;iframe src="/cards/train/latest"&gt;&lt;/iframe&gt;</code>
    </p>
</div>
{% endblock %}
